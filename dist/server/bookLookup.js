"use strict";Object.defineProperty(exports,"__esModule",{value:true});exports.BookLookup=undefined;var _createClass=function(){function defineProperties(target,props){for(var i=0;i<props.length;i++){var descriptor=props[i];descriptor.enumerable=descriptor.enumerable||false;descriptor.configurable=true;if("value"in descriptor)descriptor.writable=true;Object.defineProperty(target,descriptor.key,descriptor)}}return function(Constructor,protoProps,staticProps){if(protoProps)defineProperties(Constructor.prototype,protoProps);if(staticProps)defineProperties(Constructor,staticProps);return Constructor}}();var _request=require("request");var _request2=_interopRequireDefault(_request);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}function _classCallCheck(instance,Constructor){if(!(instance instanceof Constructor)){throw new TypeError("Cannot call a class as a function")}}var BookLookup=exports.BookLookup=function(){function BookLookup(isbnDbApiKey){_classCallCheck(this,BookLookup);this.isbnDbApiKey=isbnDbApiKey}_createClass(BookLookup,[{key:"execute",value:function execute(isbn){var _this=this;return new Promise(function(resolve,reject){_this.googleApi({isbn:isbn}).then(function(bookInfo){return _this.openLibrary(bookInfo)}).then(function(bookInfo){return _this.isbnDb(bookInfo)}).then(function(bookInfo){resolve(bookInfo.book)}).catch(reject)})}},{key:"googleApi",value:function googleApi(bookInfo){if(bookInfo.book)return bookInfo;var isbn=bookInfo.isbn;return new Promise(function(resolve,reject){(0,_request2.default)("https://www.googleapis.com/books/v1/volumes?q=isbn:"+isbn,function(error,response,body){if(!error&&response.statusCode==200){var bookDetails=JSON.parse(body);if(bookDetails&&bookDetails.totalItems>0&&bookDetails.items[0].volumeInfo){resolve({isbn:isbn,book:{author:bookDetails.items[0].volumeInfo.authors?bookDetails.items[0].volumeInfo.authors.join(", "):"",title:bookDetails.items[0].volumeInfo.title,publishedDate:bookDetails.items[0].volumeInfo.publishedDate,pageCount:bookDetails.items[0].volumeInfo.pageCount,isbn:isbn,publisher:bookDetails.items[0].volumeInfo.publisher}})}else{resolve({isbn:isbn})}}else{reject(error)}})})}},{key:"openLibrary",value:function openLibrary(bookInfo){if(bookInfo.book)return bookInfo;var isbn=bookInfo.isbn;return new Promise(function(resolve,reject){(0,_request2.default)("https://openlibrary.org/api/books?bibkeys=ISBN:"+isbn+"&jscmd=data&format=json",function(error,response,body){if(!error&&response.statusCode==200){var bookDetails=JSON.parse(body);bookDetails=bookDetails["ISBN:"+isbn];if(bookDetails){resolve({isbn:isbn,book:{author:bookDetails.authors&&bookDetails.authors.length>0?bookDetails.authors[0].name:"",title:bookDetails.title,publishedDate:bookDetails.publish_date,pageCount:bookDetails.number_of_pages,isbn:isbn,publisher:bookDetails.publishers&&bookDetails.publishers.length>0?bookDetails.publishers[0].name:""}})}else{resolve({isbn:isbn})}}else{reject(error)}})})}},{key:"isbnDb",value:function isbnDb(bookInfo){var _this2=this;if(bookInfo.book)return bookInfo;var isbn=bookInfo.isbn;return new Promise(function(resolve,reject){(0,_request2.default)("http://isbndb.com/api/v2/json/"+_this2.isbnDbApiKey+"/book/"+isbn,function(error,response,body){if(!error&&response.statusCode==200){var bookDetails=JSON.parse(body);if(bookDetails&&bookDetails.data&&bookDetails.data.length>0){resolve({isbn:isbn,book:{author:bookDetails.data[0].author_data&&bookDetails.data[0].author_data.length>0?bookDetails.data[0].author_data[0].name:"",title:bookDetails.data[0].title,publishedDate:"",pageCount:0,isbn:isbn,publisher:bookDetails.data[0].publisher_name}})}else{resolve({isbn:isbn})}}else{reject(error)}})})}}]);return BookLookup}();