"use strict";var _express=require("express");var _express2=_interopRequireDefault(_express);var _http=require("http");var _http2=_interopRequireDefault(_http);var _path=require("path");var _path2=_interopRequireDefault(_path);var _uuid=require("uuid");var _uuid2=_interopRequireDefault(_uuid);var _documentdb=require("documentdb");var _documentdb2=_interopRequireDefault(_documentdb);var _nconf=require("nconf");var _nconf2=_interopRequireDefault(_nconf);var _socket=require("socket.io");var _socket2=_interopRequireDefault(_socket);var _basicAuth=require("basic-auth");var _basicAuth2=_interopRequireDefault(_basicAuth);var _bookLookup=require("./bookLookup");var _fs=require("fs");var _fs2=_interopRequireDefault(_fs);function _interopRequireDefault(obj){return obj&&obj.__esModule?obj:{default:obj}}var port=process.env.PORT||8080;var app=(0,_express2.default)();var httpServer=_http2.default.createServer(app);var socketIoServer=_socket2.default.listen(httpServer);_nconf2.default.file(_path2.default.resolve(__dirname+"/secrets.json")).env();var secrets={documentdb_endpoint:_nconf2.default.get("documentdb_endpoint"),documentdb_primaryKey:_nconf2.default.get("documentdb_primaryKey"),documentdb_database:_nconf2.default.get("documentdb_database"),documentdb_collection:_nconf2.default.get("documentdb_collection"),isbnDbApiKey:_nconf2.default.get("isbnDbApiKey"),username:_nconf2.default.get("auth_username"),password:_nconf2.default.get("auth_password")};var bookLookup=new _bookLookup.BookLookup(secrets.isbnDbApiKey);var documentdbClient=new _documentdb2.default.DocumentClient(secrets.documentdb_endpoint,{masterKey:secrets.documentdb_primaryKey});var databaseUrl="dbs/"+secrets.documentdb_database;var collectionUrl=databaseUrl+"/colls/"+secrets.documentdb_collection;var auth=function auth(req,res,next){function unauthorized(res){res.set("WWW-Authenticate","Basic realm=Authorization Required");return res.sendStatus(401)}var user=(0,_basicAuth2.default)(req);if(!user||!user.name||!user.pass){return unauthorized(res)}if(user.name===secrets.username&&user.pass===secrets.password){return next()}else{return unauthorized(res)}};function addBook(book){return new Promise(function(resolve,reject){existsBook(book.isbn).then(function(existsAlready){if(existsAlready){reject("Book exists already");return}documentdbClient.createDocument(collectionUrl,book,function(error,book){if(error){reject(error)}else{resolve(book)}})})})}function getBooks(){return new Promise(function(resolve,reject){documentdbClient.queryDocuments(collectionUrl).toArray(function(error,books){if(error){reject(error)}else{resolve(books)}})})}function getBookById(id){return new Promise(function(resolve,reject){documentdbClient.queryDocuments(collectionUrl,"SELECT VALUE r FROM root r WHERE r.id = \""+id+"\"").toArray(function(error,books){if(error){reject(error)}else if(books.length==1){resolve(books[0])}else{reject("No book found")}})})}function existsBook(isbn){return new Promise(function(resolve,reject){documentdbClient.queryDocuments(collectionUrl,"SELECT VALUE r FROM root r WHERE r.isbn = \""+isbn+"\"").toArray(function(error,books){if(error){reject(error)}else{resolve(books.length==1)}})})}function addBookByIsbn(isbn){return new Promise(function(resolve,reject){bookLookup.execute(isbn).then(function(book){if(book){book.id=_uuid2.default.v4();book.borrowedFrom="";book.borrowedOn="";addBook(book);resolve(book)}else{reject("No book found")}}).catch(reject)})}function borrowBook(bookId,name){return new Promise(function(resolve,reject){var documentUrl=collectionUrl+"/docs/"+bookId;getBookById(bookId).then(function(book){book.borrowedFrom=name;var date=new Date;book.borrowedOn=date.getDate()+"."+(date.getMonth()+1)+"."+date.getFullYear();documentdbClient.replaceDocument(documentUrl,book,function(error,result){if(error){reject(error)}else{resolve(result)}})}).catch(function(error){reject(error)})})}function returnBook(bookId){return new Promise(function(resolve,reject){var documentUrl=collectionUrl+"/docs/"+bookId;getBookById(bookId).then(function(book){book.borrowedFrom="";book.borrowedOn="";documentdbClient.replaceDocument(documentUrl,book,function(error,result){if(error){reject(error)}else{resolve(result)}})}).catch(function(error){reject(error)})})}app.get("/version",function(req,res,next){_fs2.default.readFile(_path2.default.resolve(__dirname+"/../public/version.txt"),"utf8",function(err,data){if(!err){res.json({version:data})}next()})});app.use("/",auth,_express2.default.static(_path2.default.resolve(__dirname+"/../public")));socketIoServer.on("connection",function(socket){var clientIp=socket.request.connection.remoteAddress;console.log("Client connected:\t"+clientIp);socket.on("getBooks",function(callback){getBooks().then(function(books){return callback(books)})});socket.on("addBook",function(isbn,callback){addBookByIsbn(isbn).then(function(book){socketIoServer.sockets.emit("bookAdded",book);callback()}).catch(function(error){return callback(error)})});socket.on("borrowBook",function(id,name){borrowBook(id,name).then(function(book){socketIoServer.sockets.emit("bookBorrowed",book)})});socket.on("returnBook",function(id,name){returnBook(id,name).then(function(book){socketIoServer.sockets.emit("bookReturned",book)})})});httpServer.listen(port,function(){console.log("listening on *:"+port)});